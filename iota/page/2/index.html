<!DOCTYPE html>
<html lang="de">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="description" content="Ein Blog, zwei Themen. Die eher
	  technische Seite über das Internet der Dinge, IoT,
	  Automatisierung und Analytics. Und die menschliche Seite, es
	  gibt keine Abkürzung, über Motivation, Autonomie, Wissen,
	  Ziele und Lehre.">
    
    <meta name="author" content="Stefan Michaelis">

    <meta name="twitter:site" content="@stmichaelis">
<meta name="twitter:creator" content="@stmichaelis">

<meta name="twitter:title" content="Stefan Michaelis - Blog" />
<meta name="twitter:description" content="Ein Blog, zwei Themen. Die eher
	  technische Seite über das Internet der Dinge, IoT,
	  Automatisierung und Analytics. Und die menschliche Seite, es
	  gibt keine Abkürzung, über Motivation, Autonomie, Wissen,
	  Ziele und Lehre." />


    
    <title>Stefan Michaelis - Blog</title>

    
    <link href="https://blog.stefan-michaelis.name/iota/index.xml" rel="alternate" type="application/rss+xml" title="Stefan Michaelis - Blog" />
    <link href="https://blog.stefan-michaelis.name/iota/index.xml" rel="feed" type="application/rss+xml" title="Stefan Michaelis - Blog" />
    

    
    <link href="https://blog.stefan-michaelis.name/css/bootstrap.min.css" rel="stylesheet">
    

    
    <link href="https://blog.stefan-michaelis.name/css/clean-blog.min.css" rel="stylesheet">
    <link href="https://blog.stefan-michaelis.name/css/shariff.min.css" rel="stylesheet">
    <link href="https://blog.stefan-michaelis.name/css/clean-blog-custom.css" rel="stylesheet">
    <link href="https://blog.stefan-michaelis.name/css/syntax.css" rel="stylesheet">

    
    
    <link href="https://blog.stefan-michaelis.name/css/font-awesome.min.css" rel="stylesheet">
        <link href="https://blog.stefan-michaelis.name/css/fonts.css" rel="stylesheet">
    

</head>

<body>

    
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
		<a class="navbar-brand" href="//www.stefan-michaelis.name" style="font-family: 'Reenie Beanie';font-size:1.6em;">Stefan Michaelis</a>
            </div>

            
<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
  <ul class="nav navbar-nav navbar-right">
    <li>
      <a href="https://blog.stefan-michaelis.name">Blog</a>
    </li>
    <li>
      <a href="//www.stefan-michaelis.name/technology/de">Projekte</a>
    </li>

    <li>
      <a href="//www.stefan-michaelis.name/contact/de" rel="nofollow">Kontakt</a>
    </li>
  </ul>
</div>


        </div>
        
    </nav>


    
    
    <header class="intro-header" style="background-image: url('https://blog.stefan-michaelis.name/img/iota-bg.jpg')">
      
     <div class="container" style="width: 100%; background: linear-gradient( rgba(0, 0, 0, 0.35), rgba(0, 0, 0, 0.35) )">
       <div class="row">
         <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
           <div class="site-heading">
             <h1>IoTA</h1>
               <hr class="small">
	       <span class="subheading"><strong>Internet of Things Automation und das lernende Smart Home</strong></span>
           </div>
         </div>
       </div>
     </div>
    </header>

    
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          
                             <div class="post-preview">
                 <a href="https://blog.stefan-michaelis.name/iota/geocachet/1-die-story/">
                      <h2 class="post-title">Geocache Transposed - Teil 1</h2>
                      <h3 class="post-subtitle">Die Schatztruhe für unterwegs</h3>
                 </a>
		 <p>Vor langer Zeit sagte mir einmal jemand, dass der Computeringenieur ein schlechter
Beruf ist - um Geschenke für Familie und Freunde zu erschaffen. Maler,
sicher, diese können leicht ein Bild zeichnen und es
verschenken. Musiker, ja, sie können zu einem Geburtstag eine schöne
kleine Melodie spielen oder sogar eine ganze Hymne einem Freund
widmen. Aber wer mag schon Überraschungen mit Computern und Software?
Ich würde das auch so sehen, dass einige Optionen ein wenig geekig sein können,
aber andere können für jeden geeignet sein.  Einer davon ist ein
Geocache Transposed (GCT, Geocachet).</p>

<blockquote>
<p>Dieser Post (und die folgenden) sind die Neuauflage einer alten
Serie von Mini-Postings. Ursprünglich auf Google+ und in Englisch
gepostet sind diese jetzt nach dem Ende von G+ zu schade um für
immer verschwunden zu sein. Die Umsetzung der Box liegt inzwischen
viele Jahre zurück, die Idee dahinter ist aber zeitlos. Soweit
möglich wurden Links auf ihre Gültigkeit geprüft und ggf. angepasst
oder gelöscht.</p>
</blockquote>

<p>Geocaching ist inzwischen ein bekanntes Hobby, das von billigeren und in
Smartphones integrierten GPS-Geräten angetrieben wurde. Beim
Geocaching werden die so genannten Caches an entfernten Orten
ausgeblendet, während die Koordinaten öffentlich sind. Bei Verwendung
eines GPS-Geräts muss der Cache gefunden und in den meisten Fällen
Elemente im Cache ausgetauscht werden. Eine GCT-Box dreht dieses
Konzept auf den Kopf.</p>

<p>Der transponierte Geocache ist der sich bewegende Cache. Wer denkt
nicht gerne an die eigene Kindheit zurück, das Spiel als Piraten und
die Jagd nach geheimen Schätzen. Diesmal trägst jeder die Schatzkiste
mit sich herum und muss das Rätsel lösen um den richtigen Ort zu
finden.  Die Box selbst ist verschlossen, darin befindet sich ein
GPS-Empfänger und die Box öffnet sich nur, wenn sie an einem bestimmten Ort
der Welt aktiviert wird. An der falschen Stelle zeigt das Feld einfach
die Entfernung zum Ziel an, so dass erraten werden muss wohin die
Reise gehen soll. Der Begriff Reverse Geocache dafür und das
ursprüngliche Konzept wurde 2009 von Mikal Hart geprägt:
<a href="http://arduiniana.org/projects/the-reverse-geo-cache-puzzle/">http://arduiniana.org/projects/the-reverse-geo-cache-puzzle/</a> Er
entwarf die Box als Geschenk für die Hochzeit seines Freundes und
hat damit eine Lawine verschiedener Varianten davon ausgelöst.</p>

<p>Der Geocachet ist ein großartiges persönliches Geschenk,
für Hochzeiten, Geburtstage oder Jubiläen. Der Prozess der Erstellung
einer eigenen Box, der Auswahl des geheimen Ortes und der Beobachtung
der Versuche, das Rätsel zu lösen, ist an sich schon ein wunderbare
Sache. Und die Box ist wiederverwendbar, wenn ein neuer
geheimer Ort programmiert wird. Nachdem ich die ursprünglichen Beiträge
über die Geschichte des umgekehrten Geocache gelesen hatte, musste ich
meine eigene Box erstellen. Die folgenden Beiträge beschreiben
meinen Prozess; vielleicht werden sie auch als Inspiration für noch
weitere Puzzleboxen dienen.</p>

		 <div class="shariff" data-title="Geocache Transposed - Teil 1" data-theme="white" data-services="[&quot;whatsapp&quot;,&quot;facebook&quot;,&quot;twitter&quot;,&quot;mail&quot;]"  data-mail-url="mailto:"></div>
                 <p class="post-meta"><a href="http://www.stefan-michaelis.name">Stefan Michaelis</a> am 24.07.2019
                 </p>
               </div>
               <hr>

          
                             <div class="post-preview">
                 <a href="https://blog.stefan-michaelis.name/iota/kreuzvalidierungsfail/">
                      <h2 class="post-title">Kreuzvalidierungsfail</h2>
                      <h3 class="post-subtitle">Prinzipiell alles richtig gemacht - oder eben doch nicht</h3>
                 </a>
		 

<p>Validierung der Prognosegüte von Modellen des maschinellen Lernens
über hochgradige Kreuzvalidierung ist der Standard für zuverlässige
Aussagen. Wie man sich damit leicht selbst auf das Glatteis führen
kann, davon erzählt diese Geschichte.</p>

<h2 id="hintergrund">Hintergrund</h2>

<h3 id="sommerschule-für-maschinelles-lernen-unter-ressourcenbeschränkung">Sommerschule für maschinelles Lernen unter Ressourcenbeschränkung</h3>

<p>Der <a href="https://sfb876.tu-dortmund.de">Sonderforschungsbereich 876</a> -
Große Daten, Kleine Geräte, an der TU Dortmund führt regelmäßig
Sommerschulen zum Thema <em>Maschinelles Lernen unter
Ressourcenbeschränkung</em> durch. Ganz zum Forschungsgebiet des
Sonderforschungsbereichs passend beschäftigen sich die Sommerschulen
damit, wie die Analyse großer Daten, insbesondere auch auf
eingebetteten Systemen und im Verbund mit sehr stark beschränkten
Rechenressourcen, gelingen kann. Jede Sommerschule versucht dabei
neben den eigentlichen Kursen auch einen Hands-On-Teil dazu
anzubieten. Auch die innerhalb kürzester Zeit ausverkaufte
<a href="https://sfb876.tu-dortmund.de/SummerSchool2017/index.html">Sommerschule
2017</a> war
dabei keine Ausnahme.</p>

<img src="/images/phynode/versuchsaufbau.jpg" alt="Versuchsaufbau" class="img-responsive center-block">

<div class="caption">Versuchsaufbau aus mehreren PhyNode-Boxen</div>


<p>Das Szenario war dazu an ein Problem aus der Warenlogistik angelegt: Wie
finde ich im Regal meine Box wieder? Im Versuchsaufbau wurden zwei
kleine Wände aus Warencontainern aufgebaut, wobei jeder Container mit
einem im Projekt <a href="https://sfb876.tu-dortmund.de/SPP/sfb876-a4.html">Ressourcen-effiziente und verteilte Plattformen zur
integrativen
Datenanalyse</a>
entwickelten PhyNode-Board versehen ist.</p>

<h3 id="aufgabe">Aufgabe</h3>

<p>Die <a href="https://ieeexplore.ieee.org/document/7323355">PhyNodes</a> sind
stark ressourcenbeschränkte, autonome und weitestgehend energieautarke
eingebettete Systeme mit einer Anzahl verschiedener Sensoren.</p>

<div class="row">
     <div class="col-lg-6 col-lg-offset-3 col-md-6 col-md-offset-3 col-sm-8 col-sm-offset-2 col-xs-10 col-xs-offset-1">
     	  <img src="/images/phynode/phynode.jpg" class="img-responsive" />
     </div>
</div>


<p>Die Aufgabe der Sommerschule bestand darin, das Lernen von Positionen
von Boxen mit angebrachten PhyNodes für mehr als 20 Positionen als
Labels zu realisieren. Später sollten die Boards selbst durch die
Software auf den Boards ihre eigenen Positionen im Regal vorhersagen
können. Die Teilnehmer erhielten dazu Trainingsdaten mit der bekannten
Position. Die Boards nahmen im Verlauf verschiedene Positionen ein,
d.h. ID des Boards und Position stimmten nicht immer überein. Die
Messreihen zwischen dem Umstecken werden im Folgenden als &ldquo;Experiment&rdquo;
bezeichnet.</p>

<h2 id="features">Features</h2>

<p>Verfügbare Features waren Zeit, Board ID, Temperatur, Luxwerte,
Beschleunigungswerte X, Y, Z, RSSI zur Basistation, das Experiment und
die Position als Label. Positionen bestanden aus zwei Ziffern mit der
Bedeutung Spalte/Zeile, was für die Modellbildung aber keine Rolle
spielte, da die Aufgabe zunächst als Klassifikationsproblem behandelt
wurde.  In Summe standen nach den ersten Experimenten mehr als 330.000
Messungen zur Verfügung.</p>

<h2 id="modellierung">Modellierung</h2>

<p>Um einen ersten Eindruck von der Schwierigkeit des Problems zu
bekommen (These: Das geht gar nicht) bietet es sich an beispielsweise
eine schnelle Analyse mit <a href="https://rapidminer.com/">RapidMiner</a>
auszuprobieren. Die Daten sind damit fix eingelesen und die
wichtigsten Methoden mit ein paar Klicks verfügbar.</p>

<p>Der simple Ansatz ist dann: Daten einfach mit einem RandomForest mit
Standardparametern (10 Bäume) gelernt, 10-fache Kreuzvalidierung und
schauen, wo wir landen.</p>

<img src="/images/phynode/x-validation.png" alt="X-Validation" class="img-responsive center-block">

<div class="caption">Ausschnitt des Vorgehens bei einer 10-fachen Kreuzvalidierung</div>


<p>Die Kreuzvalidierung, insbesondere in 10-facher Ausführung stellt
dabei sicher, dass unter maximaler Ausnutzung der Trainingsdaten ein
sicheres Bild über die zu erwartende Güte gewonnen wird. Die Daten
werden dazu gleichmäßig in 10 Blöcke unterteilt, wobei in jedem
Trainings-/Testlauf ein Block für das Testing zurückbehalten wird,
während die übrigen 90 % zum Training des Verfahrens zur Verfügung stehen.</p>

<img src="/images/phynode/ConfusionMatrix_RF_Accuracy99.png" alt="Confusion Matrix Random Forest" class="img-responsive center-block">

<div class="caption">Ausschnitt der Confusion Matrix unter Einsatz eines Random Forest</div>


<p>Für den Random Forest liefert diese Validierung dann auch eine
Klassifikationsgüte von über 99 %. Ziel erreicht, perfekte
Positionsvorhersage mit einfache Mitteln ist möglich, wir können nach
Hause gehen. Schade um die Aufgabe, für eine Sommerschule war das dann
wohl doch zu einfach. Naja, es blieb immerhin noch das Problem, das
trainierte Modell auch auf die Ultra-Low-Power-Plattformen zu bringen.</p>

<h2 id="das-problem">Das Problem</h2>

<p>Mehr als 99 %, und das ohne Aufwand. Hinterlässt aber irgendwie doch
einen leichten Beigeschmack. Vielleicht lohnt es sich doch einmal
etwas näher hinter die Kulissen zu schauen. Zur einfachen
Interpretierbarkeit zeigt die folgende Abbildung den Ausschnitt aus
einem einfachen Regelmodell anstelle des Random Forest.</p>

<img src="/images/phynode/RuleModel.png" alt="RuleModel" class="img-responsive center-block">

<div class="caption">Ausschnitt eines einfachen Regel-Modells</div>


<p>So einfach sieht das Modell aber eigentlich gar nicht aus. Im
Gegenteil eher überkomplex und overfittet. Auffällig ist die
Einbeziehung der Beschleunigungs-Werte (Acc_x &hellip;). Welche Rolle
sollten diese im statischen Fall, d.h. Boards bewegen sich nicht,
spielen? Eigentlich sollte das Modell unwichtige Attribute selbst
aussortieren.</p>

<p>Es scheint als ob die Beschleunigungs-Werte einen deutlichen Bezug zur
Position <em>und</em> zum Experiment haben, quasi wie ein Fingerabdruck.</p>

<img src="/images/phynode/Experiment_Vs_AccelZ_Vs_Board.png" alt="Experiment Vs AccelZ Vs Board" class="img-responsive center-block">

<div class="caption">Plot von zwei Experimenten (Zeitachse) gegenüber Z-Beschleunigung gegenüber zwei Boards (ID, Farbe)</div>


<p>Der Plot zeigt beispielhaft den Z-Wert der Beschleunigungsmesser für
zwei Boards (rot und blau) für zwei Experimente (entlang der Zeitachse
mit kurzer Unterbrechung zum links und rechts). Die Werte sind im
Mittel stabil, deutlich voneinander trennbar, und unterscheiden sich
zwischen den Boards. Und nach dem Umstecken ändert sich der Z-Wert an
der neuen Position. Was passiert hier? Sind die Sensoren so
empfindlich, dass die Erdbeschleunigung unterschiedliche Höhen sichtbar
macht?</p>

<p>Wohl eher nicht, eine viel ernüchternde Erklärung: Die Boards scheinen
nach dem Umstecken immer leicht <em>schief</em> in den Boxen zu landen, was
die Unterschiede in den Beschleunigungswerten ausmacht und die
eindeutige Identifikation eines Boards an einer bestimmten Position
ermöglicht. Leider sind diese Werte nicht reproduzierbar, damit nur
Rauschen und nicht für ein in der Realität anwendbares Modell
geeignet. Sobald Daten eines Experiments für die Aufteilung der
Kreuzvalidierung für ein Board sowohl im Trainings- als auch im
Testdatensatz vorkommen erzeugen diese den Fingerabdruck dieses einen
Boards. Eigentlich sollten aber die Messdaten unabhängig vom Board
Rückschlüsse auf die Position erlauben. Die Beschleunigungssensoren
codieren damit (fast eindeutig) das Label (Information Leakage).</p>

<p>Und die Situation wird noch schlimmer: In den Daten sind <em>9
Experimente</em> enthalten, d.h. 9 mal Umstecken der PhyNode-Boards an
neue Positionen. In einer 10-fachen stratifizierten Kreuzvalidierung
stecken damit <em>immer</em> sowohl in Trainings- als auch Testdaten Anteile
aus allen Experimenten.</p>

<p>Wird die Kreuzvalidierung dagegen auf Batchweise umgestellt mit dem
Experiment als Attribut für den Train-/Testsplit sehen die Ergebnisse
ganz anders aus. Jetzt wird immer jeweils ein vollständiges Experiment
für den Test zurückgehalten während die anderen 8 Experimente dem
Training dienen. Schon sind es nur noch 10 % Genauigkeit, siehe dazu
wieder einen Ausschnitt der Konfusionsmatrix für einen Random Forest
mit derselben Parametrisierung wie zuvor.</p>

<img src="/images/phynode/ConfusionMatrix_RF_Accuracy10.png" alt="Confusion Matrix mit angepasster Validierung" class="img-responsive center-block">

<div class="caption">Confusion Matrix mit angepasster Validierung über vollständige Experimente</div>


<p>10 % bei mehr als 20 Labeln ist immer noch besser als raten, aber nicht
beeindruckend. Immerhin ist damit zumindest die Basis für eine
korrekte Validierung gelegt und der eigentliche Zyklus aus Modellwahl
und Parametrisierung kann beginnen.</p>

<p>Was sich in dem Szenario dann letztendlich erreichen lässt haben die
Kollegen anschließend in einer Publikation auf der <a href="https://ieeexplore.ieee.org/abstract/document/8435922">Smart SysTech
2018</a>
gezeigt. Mit viel Mühe sind damit immerhin wieder Klassifikationsgüten
von über 80 % möglich.</p>

		 <div class="shariff" data-title="Kreuzvalidierungsfail" data-theme="white" data-services="[&quot;whatsapp&quot;,&quot;facebook&quot;,&quot;twitter&quot;,&quot;mail&quot;]"  data-mail-url="mailto:"></div>
                 <p class="post-meta"><a href="http://www.stefan-michaelis.name">Stefan Michaelis</a> am 14.11.2018
                 </p>
               </div>
               <hr>

          
                             <div class="post-preview">
                 <a href="https://blog.stefan-michaelis.name/iota/homeserver2/">
                      <h2 class="post-title">Homeserver Teil 2</h2>
                      <h3 class="post-subtitle">Die Software - Von KNX bis OpenHAB</h3>
                 </a>
		 

<p>Nachdem im vorherigen <a href="https://blog.stefan-michaelis.name/iota/homeserver1/">Beitrag zum Homeserver</a>
die Hardware kurz vorgestellt wurde geht es jetzt um die Installation
der eigentlichen Steuerung. Voraussetzung ist ein lauffähiges <a href="https://www.raspberrypi.org/downloads/raspbian/">Raspbian</a>
auf dem Pi.</p>

<h2 id="knx-dämon">KNX-Dämon</h2>

<p>Standards, mehr oder weniger offen, für die Ansteuerung von
Haustechnik gibt es viele. Bei uns kommt primär
<a href="https://de.wikipedia.org/wiki/KNX-Standard">KNX</a> zum Einsatz, welches den
Vorteil hat ein offener Industriestandard zu sein und mit
(hoffentlich) entsprechend langfristiger Unterstützung und
herstellerunabhängiger Nutzbarkeit der Komponenten einhergeht. Kein
Vendor-Lock-in mehr. Bislang scheint das für unser System auch
hervorragend zu funktionieren.</p>

<p>Zur Ansteuerung der Komponenten benötigt es aber ein Gateway. Entweder
eines der kommerziellen IP-Gateways oder wie hier über ein
Hardwaremodul auf dem Raspberry Pi. Dieses benötigt allerdings noch
einen Dämon zur Ansteuerung, der sowohl die Programmierung der
Komponenten für ihre nativen Funktionen erlaubt als auch Zugriff für
die Steuerzentrale für erweiterte Funktionen.</p>

<p>Dazu gibt es mit <a href="https://github.com/knxd/knxd">knxd</a> eine freie
Alternative, die sich auch problemlos auf dem Raspberry Pi einbinden
lässt. Mit der zum aktuellen Zeitpunkt verfügbaren Version im
Hauptentwicklungszweig, 0.14 (genau genommen der Commit
<code>61a08e5fa5ce4cc6d47309bf80f9abc1fd792637</code>, da sich Version 0.14 noch
aktiv in der Entwicklung befand), gab es bislang keine Probleme, weder
beim Programmieren der Geräte noch bei der Ansteuerung von Komponenten
über den Homeserver.</p>

<p>Für den Raspberry Pi gibt es einen eigenen Abschnitt zur Konfiguration
der Schnittstelle: <a href="https://github.com/knxd/knxd#adding-a-tpuart-serial-interface-to-the-raspberry-pi">https://github.com/knxd/knxd#adding-a-tpuart-serial-interface-to-the-raspberry-pi</a></p>

<h2 id="automatisierung-mit-openhab">Automatisierung mit OpenHAB</h2>

<p>Visualisierung und Ansteuerung der Komponenten läuft dann über das
freie <a href="http://www.openhab.org/">OpenHAB-Projekt</a>. Für KNX gibt es
Alternativen, aber insbesondere durch die große Community, die Auswahl
an Plugins und die Anbindung an unzählige weitere Standards (Jemand
mit Tesla Modell S hier?) führt an Openhab kaum ein Weg vorbei.</p>

<h3 id="docker-auf-dem-raspberry-pi">Docker auf dem Raspberry Pi</h3>

<p>Die Installation von OpenHAB ist mehr oder weniger
aufwändig. Glücklicherweise existieren verschiedene Optionen auch für
den Raspberry. Eine davon ist openHABian als eigene Distribution, die
Raspbian als OS auf der SD-Karte ersetzt. Eine Alternative ist
die Nutzung von Docker.</p>

<p>Docker ist eine sogenannte Containerisierungs-Lösung, die einzelne
Software bis hin zu ganzen Betriebssystemen kapselt und (mehr oder
weniger) unabhängig vom eigentlichen System ausführbar
macht. Hauptvorteil ist damit der schnelle Wechsel zwischen
verschiedenen Versionen und im Fehlerfall die Rückkehr auf die letzte
funktionierende Version ohne sich mit Abhängigkeiten von anderen
Paketen beschäftigen zu müssen.</p>

<p>Die Installation von Docker auf dem Raspberry funktioniert reibungslos
über die Angabe von <code>curl -sSL https://get.docker.com | sh</code> auf der
Kommandozeile, siehe den Artikel <a href="https://www.raspberrypi.org/blog/docker-comes-to-raspberry-pi/">Docker comes to Raspberry
Pi</a>.</p>

<p>Fertige Images gibt es öffentlich verfügbar über den Dockerhub unter
(<a href="https://hub.docker.com/r/openhab/openhab/">https://hub.docker.com/r/openhab/openhab/</a>). Eine mögliche Variante
für den Raspberry wäre demnach</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">docker run <span class="se">\
</span><span class="se"></span>        --name openhab <span class="se">\
</span><span class="se"></span>        --net<span class="o">=</span>host <span class="se">\
</span><span class="se"></span>        --tty <span class="se">\
</span><span class="se"></span>        -v /etc/localtime:/etc/localtime:ro <span class="se">\
</span><span class="se"></span>        -v /etc/timezone:/etc/timezone:ro <span class="se">\
</span><span class="se"></span>        -v openhab_addons:/openhab/addons <span class="se">\
</span><span class="se"></span>        -v openhab_conf:/openhab/conf <span class="se">\
</span><span class="se"></span>        -v openhab_userdata:/openhab/userdata <span class="se">\
</span><span class="se"></span>        -d <span class="se">\
</span><span class="se"></span>        --restart<span class="o">=</span>always <span class="se">\
</span><span class="se"></span>        openhab/openhab:2.3.0-armhf-debian</code></pre></div>
<p>Die Option <code>--restart=always</code> sorgt dabei dafür, dass Openhab auch
nach dem Reboot oder bei Abstürzen automatisch wieder gestartet wird.
Die <code>-v openhab...</code>-Optionen machen Ordner außerhalb des Images,
d.h. vom Raspberry, innerhalb des laufenden Openhab-Containers
verfügbar. Dies ist insbesondere dann hilfreich wenn die Daten nicht
auf der SD-Karte des Raspberrys landen sollen, z.B. aus Backup-Gründen
oder um die Lebenszeit der SD-Karte durch weniger Schreibzyklen zu
erhöhen. Aus denselben Gründen kann das gesamte Docker-Root, in dem Images und
Container liegen, beispielsweise auf ein NAS verlagert werden. Dem
Thema widmet sich der nächste Abschnitt.</p>

<p>Um auch den Docker-Daemon bei jedem Boot wieder zu starten (denn auch
nur dann starten die Container wieder automatisch) muss der Service
aktiviert werden: <code>sudo systemctl enable docker</code></p>

<h3 id="einbinden-eines-nas">Einbinden eines NAS</h3>

<p>Die SD-Karte im Raspberry Pi ist (meist) klein und mit der Begrenzung
an Schreibzyklen auch anfällig für Datenverlust (wer hebt bei
regelmäßigen Vollbackups des mühselig angelegten Systems die
Hand?). Eine Möglichkeit ist Verzeichnisse mit großen Datenmengen oder
Dateien mit regelmäßigen Schreibzyklen auf ein Network Attached
Storage zu verlegen.</p>

<p>Im Wesentlichen bedeutet das hier eine Verlegung des
Docker-Datenverzeichnisses und der
OpenHAB-Konfiguratinsverzeichnisse. Dazu ist jeweils ein Eintrag in
der <code>/etc/fstab</code>-Datei notwendig:</p>

<pre><code>//&lt;nas-ip&gt;/docker /docker cifs user=&lt;nasuser&gt;,password=&lt;naspasswort&gt;,uid=root,gid=root,sec=ntlmv2,file_mode=0644,dir_mode=0755,nounix,sfu 0 0
//&lt;nas-ip&gt;/openhab /openhab cifs user=&lt;nasuser&gt;,password=&lt;naspasswort&gt;,uid=root,gid=root,sec=ntlmv2,file_mode=0700,dir_mode=0700,noperm,nounix 0 0
</code></pre>

<p>Zwingend notwendig sind natürlich die Angabe der korrekten IP-Adresse
zum NAS, die Pfade zu den Ordnern im NAS und die Zugangsdaten eines
dazu angelegten Users. Wer sein Passwort nicht in der fstab im
Klartext ablegen möchte, kann dies auch in eine Credentials-Datei
auslagern<sup class="footnote-ref" id="fnref:1"><a rel="footnote" href="#fn:1">1</a></sup>.</p>

<p>Die übrigen Optionen waren für den Betrieb mit unserem NAS ebenfalls
notwendig, z.B. um die Zugriffsrechte für Docker und den
OpenHAB-Container passend zu setzen, bei der Einrichtung starten würde
ich aber zunächst ohne und erst testen, ob der Zugriff auf das eigene
NAS auch mit den Standardwerten direkt möglich ist.</p>

<p>Damit die Ordner nach einem Neustart des Raspberry Pi sicher verfügbar
sind sollte in der Konfiguration dort per <code>sudo raspi-config</code> die
Option <em>Wait for network at boot</em> aktiviert werden.</p>

<p>Um dem Docker-Daemon das neue Root für seine Daten bekannt zu geben
ist diese in der Datei <code>/etc/docker/daemon.json</code> zu konfigurieren:</p>

<pre><code>{
  &quot;storage-driver&quot;: &quot;devicemapper&quot;,
  &quot;data-root&quot;: &quot;/docker&quot;
}
</code></pre>

<p>Der Storage-Driver legt fest, wie die Images und Container dort
abgelegt werden. <em>Devicemapper</em> wird dabei explizit nicht für eine
Produktiveinsatz empfohlen, da dieses unter anderem Probleme der
Freigabe gelöschten Speicherplatzes hat. Leider war dies die einzig
funktionierende Alternative (ymmv<sup class="footnote-ref" id="fnref:2"><a rel="footnote" href="#fn:2">2</a></sup>) und da nicht ständig neue
Container angelegt und gelöscht werden spielt der Speicherbedarf
bislang (und hoffentlich auch zukünftig) keine Rolle.</p>

<h3 id="bedienoberfläche-habpanel">Bedienoberfläche HABPanel</h3>

<p>Der letzte (und aufwändigste, bzw. nie endende) Schritt ist dann die
Konfiguration von OpenHAB und der Nutzeroberfläche. Dazu existieren
verschiedene Varianten, besonders passend für den Touchscreen des
Raspberry Pi ist <a href="https://docs.openhab.org/addons/uis/habpanel/readme.html">HABPanel</a>.</p>

<p>Zum Zugriff auf die Aktoren und Sensoren des KNX-Bus zu bekommen
müssen diese zunächst in der jeweiligen Konfiguration definiert
werden, siehe
<a href="https://www.openhab.org/addons/bindings/knx/">KNX-Binding</a>.</p>

<p>Den sogenannten Items können dann direkt im Browser den passenden
Schaltflächen zugeordnet werden.</p>

<img src="/images/habpanel.png" alt="Habpanel Startseite" class="img-responsive center-block">

<div class="caption">Übersichtsseite in OpenHAB mit HABPanel als Oberfläche</div>


<p>Der Screenshot zeigt den Übersichtsbildschirm des Wandpanels. Neben
den wichtigsten zentralen Messdaten wie Temperatur Außen/Wohnen,
Feuchte und CO2-Gehalt wird per Wetterplugin auch die Wettervorhersage
für die nächsten zwei Tagen angezeigt. Dazu kommt die Nachrüstung von
seltener genutzter Funktionalität. So können per herkömmlichem Taster
die Rollläden in Wohnzimmer und Küche nur gesamt verfahren werden, was
für 90% der Fälle auch ausreicht. Mit dem Panel dagegen ist auch die
Einzelsteuerung möglich.</p>

<h3 id="display-auf-dem-wandpanel">Display auf dem Wandpanel</h3>

<p>Die HABPanel-Oberfläche lässt sich auf jedem Gerät im lokalen Netzwerk
anzeigen und nutzen. Gedacht ist sie allerdings für das Wandpanel aus
dem Beitrag <a href="https://blog.stefan-michaelis.name/iota/homeserver1/">Homeserver - Die Hardware</a>.</p>

<p>Die Anzeige übernehmen kann der Chromium-Browser per <code>DISPLAY=:0
chromium-browser http://localhost:8080/habpanel/index.html --kiosk
--incognito</code>. Die Display-Anweisung ermöglicht den Start auch per
<code>ssh</code> aus der Ferne. Im Kiosk-Modus wird direkt im Vollbild gestartet
ohne Statusleiste und Kontrollbuttons. Der Incognito-Mode letztendlich
verhindert bei Abstürzen Fehlermeldungen beim Neustart und soll auch
die Anzahl der Zugriffe auf die Festplatte (bzw. hier auch gerne
einmal der Flashspeicher, der nicht unendlich viele Schreibzugriffe
aushält) deutlich reduzieren<sup class="footnote-ref" id="fnref:3"><a rel="footnote" href="#fn:3">3</a></sup>.</p>

<p>Üblicherweise stört der Mauszeiger noch während der Bedienung, aber
mit dem Tool <code>unclutter</code> kann dieser ausgeblendet werden. Sowohl
Browser als auch <code>unclutter</code> können im Autostart bei jedem Neustart
des Raspberry aktiviert werden: <code>nano
~/.config/lxsession/LXDE-pi/autostart</code></p>

<pre><code>@unclutter -idle 0
@chromium-browser http://localhost:8080/habpanel/index.html --kiosk --incognito

</code></pre>

<p>In der Standardeinstellung geht das Panel nach einigen Minuten in den
Standby, wacht aber bei jedem Fingerdruck wieder darauf aus. Zu
beachten ist lediglich, dass die Touch-Events auch im Schlafmodus an
die Oberfläche weiter geleitet werden und damit unter Umständen
Aktionen auslösen können. Zumindest auf der normalen Startseite
sollten daher die aktiven (klickbaren) Flächen nicht zu groß sein und
die Benutzer wissen, wo sie zur Aktivierung des Displays drücken dürfen.</p>

<p>Werden Änderungen an der HABPanel-Oberfläche vorgenommen lässt sich
dies bequemer von einem PC aus erledigen. Im Browser im Wandpanel ist
dann ein Refresh erforderlich, was im Kiosk-Modus gar nicht so einfach
ist. Über <code>DISPLAY=:0 xdotool key ctrl+F5</code> kann auch per ssh ein
Refresh ausgelöst werden und dann ist auch das Wandpanel auf der neuesten
Version der Nutzeroberfläche. Der Vorteil ist, dass neue Funktionen
erst einmal begrenzt ausprobiert werden können bevor gleich der
gesamte Haushalt mit den Neuerung konfrontiert wird.</p>

<p>Andere Möglichkeiten das Setup noch zu erweitern wären der Start von
Chromium über <code>supervise</code>, welches den Prozess permanent überwacht und
bei Abstürzen neu startet oder ein Browser-Addon, welches nach einer
gewissen Idle-Zeit wieder auf die Startseite zurückwechselt.</p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:1"><a href="https://wiki.ubuntuusers.de/Samba_Client_cifs/#Optionen">https://wiki.ubuntuusers.de/Samba_Client_cifs/#Optionen</a>
 <a class="footnote-return" href="#fnref:1"> ↩</a></li>
<li id="fn:2">Your mileage may vary
 <a class="footnote-return" href="#fnref:2"> ↩</a></li>
<li id="fn:3"><a href="https://productforums.google.com/forum/#!topic/chrome/wgKvdI7Ggj4">https://productforums.google.com/forum/#!topic/chrome/wgKvdI7Ggj4</a>
 <a class="footnote-return" href="#fnref:3"> ↩</a></li>
</ol>
</div>

		 <div class="shariff" data-title="Homeserver Teil 2" data-theme="white" data-services="[&quot;whatsapp&quot;,&quot;facebook&quot;,&quot;twitter&quot;,&quot;mail&quot;]"  data-mail-url="mailto:"></div>
                 <p class="post-meta"><a href="http://www.stefan-michaelis.name">Stefan Michaelis</a> am 08.10.2018
                 </p>
               </div>
               <hr>

          
                             <div class="post-preview">
                 <a href="https://blog.stefan-michaelis.name/iota/der-feind-im-eigenen-haus-die-rueckkehr/">
                      <h2 class="post-title">Der Feind im eigenen Haus - Die Rückkehr</h2>
                      <h3 class="post-subtitle">Instabiles Internet: Analysen, Spekulationen und unbefriedigende Ergebnisse</h3>
                 </a>
		 <p>Jetzt ist es hier einige Zeit recht ruhig gewesen, woran lag das? Nun,
zu Einem gab es viel zu tun (wann gibt es das nicht?) und zu Anderem
war da immer noch diese lästige Problem der instabilen
Internetverbindung, was doch immer irgendwie im Hinterkopf schwebt
(genaus wie die Klagen zuhause, dass Internet wäre ständig weg). Die
Analysen und Spekulationen haben entsprechend Zeit gekostet bis
immerhin ein (nicht ganz befriedigender) Workaround zu finden war.
</p>

<h2 id="was-bisher-geschah">Was bisher geschah</h2>

<p>In
<a href="https://blog.stefan-michaelis.name/iota/der-feind-in-meinem-haus/">Der Feind in meinem Haus</a> ging
es das erste Mal um Probleme mit dem Internet. Damals brach unregelmäßig
die Verbindung vom Router zum WAN ab, Ursache unklar. Erste
Vermutungen brachten einen mDNS-Storm verursacht durch
Google-castfähige Geräte ins Spiel, was ungefähr auch zu diesem
Zeitpunkt durch die Presse ging. Das mDNS-Problem war real, die
(alleinige) Ursache war es aber nicht. Also weitersuchen und
letztendlich bliebe nur eine Störungsmeldung beim Provider.</p>

<h2 id="ursachensuche">Ursachensuche</h2>

<p>Um dem Provider nicht unpräzise mitteilen zu müssen: <em>Internet fällt
aus.</em> Wann, wie oft? <em>Weiß nicht, gefühlt immer dann wenn man es
braucht.</em> war der erste Schritt überhaupt einmal mitzuloggen, wann es
überhaupt zu Problemen kommt. Vielleicht zeigen sich da schon
Regelmäßigkeiten. Als schnell ein Skript erstellt, das eine externe
Webseite aufruft, auf dem Raspberry, der sowieso 24/7 läuft,
installiert und erst einmal Daten gesammelt.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/bash
</span><span class="cp"></span><span class="k">while</span> true<span class="p">;</span> <span class="k">do</span>
    <span class="nv">dt</span><span class="o">=</span><span class="k">$(</span>date +%Y%m%d_%H%M%S<span class="k">)</span>
    wget -q --tries<span class="o">=</span><span class="m">5</span> --timeout<span class="o">=</span><span class="m">30</span> --spider http://&lt;seite_des_vertrauens.com&gt;
    
    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$?</span> -eq <span class="m">0</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$dt</span><span class="s2">:Online&#34;</span>
    <span class="k">else</span>
        <span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$dt</span><span class="s2">:Offline&#34;</span>
    <span class="k">fi</span>
    sleep <span class="m">30</span>
<span class="k">done</span></code></pre></div>
<p>Die Auswertungen geben dem Gefühl der &ldquo;ständigen&rdquo; Ausfälle wenigstens
ein konkretes Gesicht: Wie lange, wie oft?</p>

<img src="/images/ausfallzeitjeTag.png" alt="Ausfallzeit je Tag" class="img-responsive center-block">

<div class="caption">Ausfallzeiten je Tag zeigen keine offensichtlichbegründbaren Besonderheiten</div>

<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="kn">library</span><span class="p">(</span>tidyverse<span class="p">)</span>
<span class="kn">library</span><span class="p">(</span>lubridate<span class="p">)</span>

du <span class="o">&lt;-</span> read_delim<span class="p">(</span><span class="s">&#34;dsluptime.log&#34;</span><span class="p">,</span> delim <span class="o">=</span> <span class="s">&#34;:&#34;</span><span class="p">,</span>
                 col_names <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">&#34;Time&#34;</span><span class="p">,</span> <span class="s">&#34;Status&#34;</span><span class="p">),</span>
                 col_types <span class="o">=</span> cols<span class="p">(</span>
                     Time <span class="o">=</span> col_datetime<span class="p">(</span><span class="s">&#34;%Y%m%d_%H%M%S&#34;</span><span class="p">),</span>
                     Status <span class="o">=</span> col_factor<span class="p">(</span>levels <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">&#34;Offline&#34;</span><span class="p">,</span> <span class="s">&#34;Online&#34;</span><span class="p">))</span>
                 <span class="p">))</span>

du <span class="o">%&gt;%</span>
    filter<span class="p">(</span>Status <span class="o">==</span>  <span class="s">&#34;Offline&#34;</span><span class="p">)</span> <span class="o">%&gt;%</span>
    group_by<span class="p">(</span>day<span class="o">=</span>wday<span class="p">(</span>Time<span class="p">,</span> label <span class="o">=</span> <span class="kc">TRUE</span><span class="p">,</span> week_start <span class="o">=</span> <span class="m">1</span><span class="p">))</span> <span class="o">%&gt;%</span>
    count<span class="p">(</span>day<span class="p">)</span> <span class="o">%&gt;%</span>
    ggplot<span class="p">(</span>mapping <span class="o">=</span> aes<span class="p">(</span>x <span class="o">=</span> day<span class="p">,</span> y <span class="o">=</span> n <span class="o">*</span> <span class="m">0.5</span><span class="p">))</span> <span class="o">+</span>
    geom_col<span class="p">()</span> <span class="o">+</span> labs<span class="p">(</span>x <span class="o">=</span> <span class="s">&#34;Wochentag&#34;</span><span class="p">,</span> y <span class="o">=</span> <span class="s">&#34;Summe Ausfallzeit [Minuten]&#34;</span><span class="p">)</span> </code></pre></div>
<p>Die Summe der Ausfallzeiten je Tag ist zwar nicht gleichverteilt, aber
richtig interpretierbar sieht es auch nicht aus. Auffällig sind die im
Vergleich geringen Ausfälle an Freitagen, das Wochenende ist
(überraschenderweise) ebenfalls leicht weniger betroffen, weicht aber
nicht allzu stark von den übrigen Wochentagen ab.</p>

<img src="/images/ausfallzeitjeStunde.png" alt="Ausfallzeit je Stunde" class="img-responsive center-block">

<div class="caption">Die Ausfallzeiten je Stunde zeigen Häufungen im Abendbereich</div>

<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r">du <span class="o">%&gt;%</span>
    filter<span class="p">(</span>Status <span class="o">==</span>  <span class="s">&#34;Offline&#34;</span><span class="p">)</span> <span class="o">%&gt;%</span>
    group_by<span class="p">(</span>day<span class="o">=</span>hour<span class="p">(</span>Time<span class="p">))</span> <span class="o">%&gt;%</span>
    count<span class="p">(</span>day<span class="p">)</span> <span class="o">%&gt;%</span>
    ggplot<span class="p">(</span>mapping <span class="o">=</span> aes<span class="p">(</span>x <span class="o">=</span> day<span class="p">,</span> y <span class="o">=</span> n <span class="o">*</span> <span class="m">0.5</span><span class="p">))</span> <span class="o">+</span>
    geom_col<span class="p">()</span> <span class="o">+</span> labs<span class="p">(</span>x <span class="o">=</span> <span class="s">&#34;Stunde&#34;</span><span class="p">,</span> y <span class="o">=</span> <span class="s">&#34;Summe Ausfallzeit [Minuten]&#34;</span><span class="p">)</span> </code></pre></div>
<p>Bei der Betrachtung der Ausfallzeiten gestaffelt nach Stunden zeigen
sich die meisten Ausfälle in den Abendstunden, was eine gewisse
Abhängigkeit von der generellen Auslastung erahnen ließe.</p>

<img src="/images/ausfalldauerTag.png" alt="Ausfalldauern je Tag" class="img-responsive center-block">

<div class="caption">Die Ausfalldauern je Tag zeigen nur bedingt Korrelationen mit dem Gesamtausfall</div>

<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r">du <span class="o">%&gt;%</span>
    filter<span class="p">(</span>Status <span class="o">==</span>  <span class="s">&#34;Offline&#34;</span><span class="p">)</span> <span class="o">%&gt;%</span>
    group_by<span class="p">(</span>date <span class="o">=</span> as_date<span class="p">(</span>Time<span class="p">))</span> <span class="o">%&gt;%</span>
    count<span class="p">(</span><span class="kp">date</span><span class="p">)</span> <span class="o">%&gt;%</span>
    mutate<span class="p">(</span>wday <span class="o">=</span> wday<span class="p">(</span><span class="kp">date</span><span class="p">,</span> label <span class="o">=</span> <span class="kc">TRUE</span><span class="p">,</span> week_start <span class="o">=</span> <span class="m">1</span><span class="p">))</span> <span class="o">%&gt;%</span>
    ggplot<span class="p">(</span>mapping <span class="o">=</span> aes<span class="p">(</span>x <span class="o">=</span> wday<span class="p">,</span> y <span class="o">=</span> n <span class="o">*</span> <span class="m">0.5</span><span class="p">))</span> <span class="o">+</span>
    geom_boxplot<span class="p">()</span>  <span class="o">+</span> labs<span class="p">(</span>x <span class="o">=</span> <span class="s">&#34;Wochentag&#34;</span><span class="p">,</span> y <span class="o">=</span> <span class="s">&#34;Dauer je Ausfall [Minuten]&#34;</span><span class="p">)</span></code></pre></div>
<img src="/images/ausfalldauerStunde.png" alt="Ausfalldauern je Stunde" class="img-responsive center-block">

<div class="caption">Die Ausfalldauern je Stunde zeigen nur bedingt Korrelationen mit dem Gesamtausfall</div>

<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r">du <span class="o">%&gt;%</span>
    filter<span class="p">(</span>Status <span class="o">==</span>  <span class="s">&#34;Offline&#34;</span><span class="p">)</span> <span class="o">%&gt;%</span>
    group_by<span class="p">(</span>hour<span class="o">=</span>hour<span class="p">(</span>Time<span class="p">))</span> <span class="o">%&gt;%</span>
    group_by<span class="p">(</span>date <span class="o">=</span> as_date<span class="p">(</span>Time<span class="p">))</span> <span class="o">%&gt;%</span>
    count<span class="p">(</span>hour<span class="p">)</span> <span class="o">%&gt;%</span>
    ggplot<span class="p">(</span>mapping <span class="o">=</span> aes<span class="p">(</span>x <span class="o">=</span> <span class="kp">factor</span><span class="p">(</span>hour<span class="p">),</span> y <span class="o">=</span> n <span class="o">*</span> <span class="m">0.5</span><span class="p">))</span> <span class="o">+</span>
    geom_boxplot<span class="p">()</span> <span class="o">+</span> labs<span class="p">(</span>x <span class="o">=</span> <span class="s">&#34;Stunde&#34;</span><span class="p">,</span> y <span class="o">=</span> <span class="s">&#34;Dauer je Ausfall [Minuten]&#34;</span><span class="p">)</span></code></pre></div>
<p>Die Boxplots der Ausfälle aufgeteilt jeweils nach Tagen und Stunden
(Summe innerhalb jedes einzelnen Tags, jeder einzelnen Stunde an jedem
Tag; d.h. zwei Ausfälle innerhalb derselben Stunde werden
zusammengefasst) sollen einen möglichen Zusammenhang zwischen den
Tagen/Stunden mit insgesamt einer hohen Ausfallzeit und der Dauer
innerhalb dieser Stunde zeigen. Bestätigt hat sich das nicht. Hohe
Werte für die Gesamtsumme (z.B. in den Abendstunden) ergeben sich nur
durch mehr Ausfälle an mehreren Tagen. Insgesamt zeigt sich aber eine
hohe Varianz wie schlimm/lang ein Ausfall sein kann.</p>

<h2 id="lösungsversuche">Lösungsversuche</h2>

<p>Damit scheint dann aber fast klar: Der Provider ist schuld und der Knoten
überbucht. In den Abendstunden häufen sich die Ausfälle, wenn alle
anderen auch Datenverkehr erzeugen. Also wird nichts anderes übrig
bleiben als ein Supporticket zu öffnen und eine Lösung zu suchen,
hmpf. So der Plan. Bis wir in Urlaub gefahren sind. Das Ticket ist aus
Trägheit noch nicht eröffnet, schließlich funktioniert der
Internetzugang irgendwie ja doch immer mal wieder, und Lust auf
Gespräche mit der Hotline besteht auch nicht.</p>

<p>Und im Urlaub? Nur ein einziger kurzer Miniausfall, was auch alle möglichen
Ursachen haben kann. Sollte das Problem doch bei uns im Haus liegen?
Während des Urlaubs war WLAN komplett deaktiviert, Internetverkehr nur
durch das Skript zum Verbindungsstatus und Kleinigkeiten wie hin und wieder
mal ein NTP-Synchronisation.</p>

<h3 id="wlan-jetzt-woanders">WLAN jetzt woanders</h3>

<p>Die Easybox 804 wird in Foren gerne für ihr WLAN kritisiert. Falls
dort das Problem läge, ließe sich das mit anderer Hardware
lösen. Gefallen ist die Wahl auf einen
<a href="https://www.ubnt.com/unifi/unifi-ap-ac-lite/">Ubiquit Unifi Accesspoint AC AP Lite</a>,
der in Bewertungen als recht konfigurierbar und stabil gilt, aber für kleine
Setups eine recht umständliche zu nutzende Konfigurationssoftware
besitzt. Die Reichweite der Easybox war zwar in Ordnung, aber ein
zweiter Accesspoint sollte eh die Abdeckung verbessern.</p>

<p>Angeschafft, konfiguriert, WLAN an der Easybox abgeschaltet, und
geholfen hat es nichts.</p>

<p>Bis zu dem Zeitpunkt als während des Ausräumens der Waschmaschine
wieder der Ruf kam: &ldquo;Kein Internet!&rdquo;. Ein zufälliger Blick auf den
Switch zeigte zwei wild blinkende LEDs, merkwürdig. Gehören tun sie zum
neuen Access Point und dem Router. Da war wohl gerade ziemlich Last
auf der Verbindung und über den Router sollte eben nur Datenverkehr
ins Internet gehen. Im Wohnzimmer zeigt die beste Gattin der Welt zum
Beweis des fehlenden Internets auf ihr Huawei P10. Auch andere Geräte
im Haus haben kein Netz und der Router selbst loggt wieder seine
WAN-Disconnects. Die Bitte, das P10 auszuschalten zeigt zunächst keine
Wirkung (wie auch, Android-Smartphones sind ja nicht wirklich aus wenn
der Bildschirm aus ist, sondern treiben wer weiß was im Hintergrund)
und erst das echte Herunterfahren bringt die LEDs zum Schweigen,
bzw. Dauerleuchten. Internet ist prompt auch wieder da&hellip;</p>

<h3 id="logging-voraus">Logging voraus</h3>

<p>Da wäre als ein Kandidat als mögliche Ursache für die
Verbindungsabbrüche vorhanden, aber was macht das Smartphone da
überhaupt? Wird der Router überlastet wie potenziell bei den
mDNS-Broadcasts (wobei der ein wenig Datenverkehr schon aushalten
sollte).</p>

<p>Jetzt hat sich die Anschaffung eines Smart-Switches doch noch
gelohnt. Den Port zum Festnetz-PC als Monitoringport konfiguriert und
Wireshark mitlaufen lassen um zu sehen, wie viel Datenverkehr wohin
überhaupt vorkommt.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Aufzeichnung nur für einen Client (hier das Smartphone)
</span><span class="c1"># und Beschränkung auf 50 MByte-Dateien
</span><span class="c1"></span>dumpcap -i eth0 - -b filesize:50000 -f <span class="s2">&#34;host &lt;clientip&gt;&#34;</span> -w trace.pcap</code></pre></div>
<p>Und in der Tat zeigt das Log gleich mehrere Datenverbindungen zu
unterschiedlichen IP-Adressen und volle Auslastung im Upload und auch
nicht wenig im Download, allerdings nicht an der
Maximalgeschwindigkeit. Immerhin besitzen wir hier eine ultraschnelle
Breitbandanbindung mit <em>bis zu</em> 16 MBit/s im Down- und 1 MBit/s im
Upstream. Und ich habe mal gedacht, wir würden im Ruhrgebiet, einer
der dichtbesiedelsten Region Deutschlands, und nicht auf dem Land leben.</p>

<p>Im P10 selbst lässt sich zusätzlich auch für WLAN mit immerhin
stündlicher Auflösung der Datenverbrauch von Apps anzeigen. Sortiert
nach Datenvolumen zeigen sich die üblichen Verdächtigen: Google Fotos,
Google-Backup-Transferdienst, K9-Mail, WhatsApp, PlayStore, HiCare,
Wetterdatenservice, Instagram. Im Wireshark-Trace lässt sich dies über
Reverse-Lookup der IP-Adressen zumindest teilweise nachvollziehen,
jeglicher auffälliger Traffic würde darin aber vermutlich
untergehen.</p>

<h3 id="energiesparen">Energiesparen</h3>

<p>Aber warum stürmen die Apps nahezu gleichzeitig auf das WLAN los?
Eines der Feature (manche bezeichnen es aber auch als Bug) ist das
aggressive Energiesparen im angepassten Android von Huawei. Kein
Wunder, wenn die Prozesse beschränkt werden, schlafen liegen und dann
gesammelt bei jeder sich bietenden Gelegenheit in den Wettbewerb der
schnellsten Aktualisierung treten. Nur lässt sich daran etwas ändern
und verschwinden die Verbindungsabbrüche, wenn sich die
Datenverbindungen zeitlich entzerren lassen?</p>

<p>In
der
<a href="https://consumer.huawei.com/de/support/how-to/detail-troubleshooting/?resourceId=898690">Huawei FAQ</a> gibt
es sogar einen eigenen Unterpunkt, der sich mit dem Wechsel auf WLAN
beschäftigt, was auch der Fall wäre wenn das Gerät aus dem Standby
erwacht. Zitat:</p>

<blockquote>
<p>Nach der Verbindung mit einem WLAN-Netzwerk oder beim Umschalten
zwischen einer WLAN- und einer mobilen Datenverbindung, warten Sie
etwa 30 Sekunden, bevor Sie Apps verwenden, und überprüfen Sie dann,
ob die Internet-Geschwindigkeit normal ist.</p>
</blockquote>

<p>Strom sparen (versuchen) bis zum letzten Tropfen, aber die User
Experience so weit vernachlässigen, dass es eines eigenen FAQ-Eintrags
bedarf, ts. Das lässt sich technisch auch anders lösen.</p>

<p>Ein Versuch dies zu entzerren war die Energiespareinstellungen für die
intensivsten Apps, insbesondere Fotos, zu deaktivieren und analog den
unbeschränkten Datenzugriff, auch im Hintergrund, zu aktivieren. Wo
diese Einstellungen liegen lohnt gar nicht zu dokumentieren, das
ändert sich anscheinend öfter, denn fast alle Beiträge mit
Beschreibungen, wo diese zu finden wären, waren schon veraltet. Für
nicht ganz so wichtige Apps wurde der Datenzugriff gleich ganz
verboten&hellip;</p>

<p>Aber es lässt sich schon erahnen: Gebracht hat es nichts. Über
Maßnahmen wie Löschen des Caches oder Einstellungen in den Apps müssen
wir auch nicht weiter reden. Irgendwann einmal hatte Google Fotos auch
die Einstellung nur beim Laden zu sichern. Gone with the wind&hellip;</p>

<h3 id="bufferbloat">Bufferbloat</h3>

<p>Eigentlich ist das Internet auf Fairness aufgebaut. TCP-Verbindungen
sollten sich schön die verfügbare Bandbreite aufteilen, so dass für
jeden etwas bleibt. Klar, insbesondere im schmalen Uplink bleibt dann
nicht mehr viel übrig, aber ganz ausgehungert sollte keine Verbindung sein. Bis
die Recherchen rund um die Verbindungsabbrüche auf die Seite
über <a href="https://www.bufferbloat.net/projects/">Bufferbloat</a> geführt
haben. Bufferbloat? Aber Speedtests waren doch alle in Ordnung? Nach
Schwierigkeiten als der Anschluss noch neu war haben sich die
Speedtests diverser Webseiten fast auf dem Maximum des Anschlusses
eingependelt.</p>

<p>Aber Bufferbloat ist anders. Ist der Puffer bei einem der
Geräte auf der Wegstrecke, und bei DSL ist dies üblicherweise der Router, zu groß,
funktionieren die Ausgleichsmechanismen nicht mehr. Einzelne Pakete
oder langsamere Datenverbindungen stecken dann im Puffer fest, die
Latenzen schießen in die Höhe. Mittels einem kontinuierlichen Ping
während eines Speedtests oder Tests
wie <a href="https://fast.com/de">fast.com</a> von Netflix lässt sich das Problem
relativ leicht nachvollziehen: Steigt die Latenz während einer
ausgelasteten Verbindung an gibt es vermutlich ein Bufferbloat-Problem
und letztendlich leidet auch hier die Nutzererfahrung. Und siehe da:
Insbesondere im Uplink steigt die Latenz um den Faktor 10. Ist die
Easybox die Ursache? Danach sieht es aus, müsste aber im Tausch mit
anderen Geräten verifiziert werden. Vielleicht bekommt man eben doch
nur das, was man bezahlt.</p>

<p>Aber, wir erinnern uns: Es sind nicht nur einzelne Verbindungen und
Endgeräte, die den Kürzeren ziehen, auch die gesamte WAN-Verbindung
fällt regelmäßig aus.</p>

<h3 id="workaround-drosseln">Workaround: Drosseln</h3>

<p>So nicht zu erklären sind eben diese Abbrüche. Um eine Überlastung des
Routers auszuschließen bleibt nur noch die Möglichkeit den
Datenverkehr unter die Maximalgeschwindigkeit zu drosseln. Der Unifi
Access Point bietet die Möglichkeit dies für gesamte SSIDs und sogar
einzelne Clients zu tun. Hurra! Dann wird das P10 eben
gebremst. Funktioniert aber nicht, hmpf. Scheint ein Problem in der
aktuellen Firmware zu sein. Laut Ubiquiti-Foren kommt es öfter
vor, dass Funktionen in der einen Firmware funktionieren und der
nächsten wieder nicht. Auf Abhilfe zu warten ist nicht zielführend,
also wieder auf den Smart Switch zurückgegriffen und den ganzen Port
gedrosselt. Sicherheitshalber auf 10 MBit/s im Down- und 800 KBit/s im
Uplink, was noch genügend Reserven zur Maximalrate lässt, aber gerade
für Smartphones beim Browsen nicht allzu sehr auffällt. Dumm nur, dass
damit auch alle anderen WLAN-Geräte betroffen sind, die vielleicht
gerne doch in voller Geschwindigkeit im Heimnetz unterwegs gewesen
wären.</p>

<p>Aber siehe da, seit der Drosselung <strong>kein einziger</strong>
WAN-Verbindungsabbruch mehr. Natürlich besteht das Problem der im
Endgerät lokal verstopften Leitung oder von Bufferbloat generell immer
noch, allerdings in deutlich abgeschwächter Form und der Eindruck
<em>Internet weg</em> entsteht gar nicht mehr. Damit lässt sich, zumindest
temporär, leben.</p>

<h2 id="das-ende">Das Ende</h2>

<p>Die eigentliche Ursache ist aber immer noch unklar und doch ein Fall
für eine Störungsmeldung an den Provider. Überlastung, nur weil der
Link voll ausgenutzt wird, dürfte auch im Consumergerät kein Problem
sein. Mit üblichen Speedtests, auch mehrerer Datenströme parallel,
ließen sich die Abbrüche nicht nachstellen.</p>

<p>Aber nicht zu jedem Ausfall der externen Internetanbindung sah der
Datenverkehr nach einer wilden Ansammlung angestauter Datenverbindung
aus. Ein einzelner Datenstrom konnte ebenso zum Ausfall führen.</p>

<img src="/images/quictrace.png" alt="Wireshark Trace" class="img-responsive center-block">

<div class="caption">Wireshark-Trace einer einzelnen QUIC-Verbindung mit maximaler Uploadrate</div>


<p>QUIC (alias GQUIC), was ist
<a href="https://de.wikipedia.org/wiki/Quick_UDP_Internet_Connections">QUIC</a>?
UDP-Datenverkehr und das auch noch auf Port 443 (https), welchen Sinn
hat das denn?</p>

<p>QUIC ist ein auf UDP basierendes Protokoll, von Google ins Leben
gerufen, als Testfeld für neue Managementalgorithmen für die
Datenverbindung, unter anderem weil sich mit den normalen
Standardisierungsprozessen z.B. auf TCP zu wenig/langsam Einfluss
nehmen ließe. QUIC selbst ist schon einige Jahre alt (ich werde auch
alt, das Protokoll kannte ich noch nicht) und findet zunehmend Einsatz in
Google-Produkten. Und in der Tat zeigt ein Reverse-Lookup für die
IP-Adresse auf Google-Server. Das muss allerdings noch nicht auf ein
Google-Produkt als Quelle hinweisen, da unter Umständen auch die
Nutzung von Google-APIs durch Drittentwickler QUIC nutzen könnte,
allerdings waren diverse Google-Dienste und insbesondere die Foto-App
in der Summe des Datenvolumens immer vorne mit dabei.</p>

<p>Ein Durchsatztest für QUIC scheint noch nicht zu existieren, das
Protokoll ist auch noch im Standardisierungsprozess, also fix selbst einen
Loadtest auf Basis einer freien Implementierung
entworfen:
<a href="https://github.com/stmichaelis/quic-loadtest">QUIC-Loadtest</a>.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Server
</span><span class="c1"></span>quic-loadtest -s &lt;publicip&gt;:4242 -q -p <span class="m">1300</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Client
</span><span class="c1"></span>quic-loadtest -c &lt;publicip&gt;:4242 -d <span class="m">600</span> -q -p <span class="m">1300</span></code></pre></div>
<p>Aber auch dieser Test zeigt wunderbaren Durchsatz im Bereich der
zugesicherten Geschwindigkeit. Als einziger offensichtlicher
Unterschied zum Trace bleibt nur noch der Port 443. Also das
Experiment noch einmal wiederholt, in diesem Durchlauf dann mit
privilegiertem Port für den Server (entsprechend als Root, schön öffentlich
erreichbar im gesamten Internet, also bloß schnell mit dem Test sein).</p>

<img src="/images/netzwerkverlauf.png" alt="Netzwerkverlauf" class="img-responsive center-block">

<div class="caption">Netzwerkverlauf/Durchsatz bis zum Verbindungsabbruch</div>


<p>Und jetzt - endlich - bricht die WAN-Verbindung ab. Wiederholungen
zeigen immer das gleiche Bild: Perfekter Durchsatz auf Port 4242
(ebenso auf 30, ebenfalls im Bereich der privilegierten Ports, aber
keinem Protokoll zugeordnet), auf Port 443 dagegen nach 2 Minuten, spätestens
nach knapp 10 Minuten Zwangstrennung. Ob durch den Router oder von
außerhalb durch den Provider ist aus dem Log nicht zu entnehmen. Aber
spätestens ab hier sieht es nach Absicht aus.</p>

<p>Warum nur wird die Verbindung nur bei UDP-Verkehr auf dem HTTPS-Port
und nur unter Volllast beendet? Soll das eine Denial-of-Service-Abwehr
sein, da UPD-Verkehr auf diesem Port eher ungewöhnlich ist (aber mit
Google als Hauptnutzer dann doch wieder nicht so ungewöhnlich). Liegt
einfach ein Fehlkonfiguration vor? Sind die Experimente nicht korrekt
und das Problem liegt doch irgendwo anders? Um sicher zu gehen wären
weitere und unabhängige Tests notwendig. Und warum sollte das
keinem vorher aufgefallen sein? Ein dumme Kombination aus Anschluss,
Router und Endgeräten?</p>

<p>Der First-Level-Support des Providers zeigte sich zwar noch
interessiert und wollte das Vorgehen zur Reproduktion des Ausfalls an
die Technik weitergeben, ein Techniker würde sich direkt zeitnah
melden, passiert ist aber nichts.</p>

<p>Eine endgültige Auflösung wird es wohl nicht geben: Der Anschluss beim
Provider ist sicherheitshalber gekündigt und das P10 hat Kontakt mit
der Badewanne gehabt&hellip;</p>
		 <div class="shariff" data-title="Der Feind im eigenen Haus - Die Rückkehr" data-theme="white" data-services="[&quot;whatsapp&quot;,&quot;facebook&quot;,&quot;twitter&quot;,&quot;mail&quot;]"  data-mail-url="mailto:"></div>
                 <p class="post-meta"><a href="http://www.stefan-michaelis.name">Stefan Michaelis</a> am 21.08.2018
                 </p>
               </div>
               <hr>

          
          
          <ul class="pager">
	    
            <li class="next">
              <a href="/iota/">Neuer &rarr;</a>
            </li>
	    
	    
	    <li class="previous">
              <a href="/iota/page/3/">&larr; Älter</a>
            </li>
	    
          </ul>
        </div>
      </div>
    </div>

   
    <footer>
      <div class="container">
          <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
              <ul class="list-inline text-center">
		
		<li>
                  <a href="https://blog.stefan-michaelis.name/iota/index.xml" type="application/rss+xml" target="_blank">
                    <span class="fa-stack fa-lg">
                      <i class="fa fa-circle fa-stack-2x"></i>
                      <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                    </span>
                  </a>
		</li>
		
		<li>
                  <script language="Javascript" type="text/javascript">
		    <!--
			document.write('<a href="mai');
			document.write('lto');
			document.write(':&#105;&#110;&#102;&#111;');
			document.write('@');
			document.write('&#115;&#116;&#101;&#102;&#97;&#110;&#45;&#109;&#105;&#99;&#104;&#97;&#101;&#108;&#105;&#115;&#46;&#110;&#97;&#109;&#101;">');
			
</script>
                    <span class="fa-stack fa-lg">
                      <i class="fa fa-circle fa-stack-2x"></i>
                      <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                    </span>
                    <script language="Javascript" type="text/javascript">
		    <!--
			document.write('<\/a>');
			
		    </script>		
		</li>
		<li>
                  <a href="https://www.xing.com/profile/Stefan_Michaelis5">
                    <span class="fa-stack fa-lg">
                      <i class="fa fa-circle fa-stack-2x"></i>
                      <i class="fa fa-xing fa-stack-1x fa-inverse"></i>
                    </span>
                  </a>
		</li>
		<li>
                  <a href="https://de.linkedin.com/in/stefanmichaelis">
                    <span class="fa-stack fa-lg">
                      <i class="fa fa-circle fa-stack-2x"></i>
                      <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                    </span>
                  </a>
		</li>
		<li>
                  <a href="https://twitter.com/stmichaelis">
                    <span class="fa-stack fa-lg">
                      <i class="fa fa-circle fa-stack-2x"></i>
                      <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                    </span>
                  </a>
		</li>
		<li>
                  <a href="https://github.com/stmichaelis">
                    <span class="fa-stack fa-lg">
                      <i class="fa fa-circle fa-stack-2x"></i>
                      <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                    </span>
                  </a>
		</li>
              </ul>
	      <p class="copyright text-muted"><a href="//www.stefan-michaelis.name/contact/de" rel="nofollow">Impressum</a>
		<a href="//www.stefan-michaelis.name/contact/de#privacy" rel="nofollow">Datenschutz</a>
	      </p>
            </div>
          </div>
	</div>
    </footer>

    
    
    
    
    <script src="https://blog.stefan-michaelis.name/js/jquery.min.js"></script>

    
    
    
    <script src="https://blog.stefan-michaelis.name/js/bootstrap.min.js"></script>

    
    <script src="https://blog.stefan-michaelis.name/js/clean-blog.js"></script>
    <script src="https://blog.stefan-michaelis.name/js/shariff.min.js"></script>

    

</body>

</html>

